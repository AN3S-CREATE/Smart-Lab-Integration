<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neurologix AI — Smart Lab Integration Monitor</title>
  <style>
    :root{
      /* ===== STYLE TOKENS ===== */
      --bg0:#05070a;
      --bg1:#0f131a;
      --bg2:#1a212b;
      --bg3:#26303d;

      --text:#F6F3EA;

      --accent:#D2FF05;      /* Neon Green */
      --accent2:#9AD153;     /* Secondary Green */
      --deep:#527D2D;        /* Deep Green */
      --warm0:#B8901F;       /* Warm Warning */
      --warm1:#EED56F;
      --danger:#ff0542;      /* Critical/Malfunction (Red preserved for errors) */

      /* System */
      --s:8px;               /* 8pt spacing system */
      --r:20px;              /* radius */
      --r2:16px;

      --line: rgba(246,243,234,.12);
      --line2: rgba(246,243,234,.06);
      --glass: rgba(15,19,26,.65);
      --glass2: rgba(26,33,43,.45);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --head: "Montserrat","Space Grotesk", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --body: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --shadow: 0 16px 40px rgba(0,0,0,.60);
      --glow: 0 0 20px rgba(210, 255, 5, 0.15);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--body);
      color: var(--text);
      background:
        radial-gradient(1400px 900px at 20% -10%, rgba(210,255,5,.10), transparent 60%),
        radial-gradient(1000px 800px at 80% 10%, rgba(154,209,83,.08), transparent 55%),
        radial-gradient(1000px 800px at 50% 110%, rgba(210,255,5,.05), transparent 60%),
        var(--bg0);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(var(--s)*2);
    }

    /* 16:9 frame */
    .frame{
      width: min(1600px, 96vw);
      aspect-ratio: 16 / 9;
      height: min(900px, 92vh);
      max-height: 92vh;
      min-height: 650px;
      border-radius: calc(var(--r) + 6px);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(26,33,43,.55), rgba(5,7,10,.92));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    /* Tech grid overlay */
    .frame:before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(90deg, rgba(210,255,5,.03) 1px, transparent 1px) 0 0 / 80px 80px,
        linear-gradient(0deg, rgba(246,243,234,.02) 1px, transparent 1px) 0 0 / 80px 80px;
      pointer-events:none;
      mix-blend-mode: screen;
      z-index: 0;
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      position:relative;
      z-index: 1;
    }

    /* ===== Top bar ===== */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: calc(var(--s)*2);
      padding: calc(var(--s)*2) calc(var(--s)*3);
      border-bottom: 1px solid var(--line2);
      background: rgba(5,7,10,.55);
      backdrop-filter: blur(12px);
    }

    .title{
      display:flex;
      flex-direction:column;
      gap: calc(var(--s)*.5);
      min-width: 320px;
    }
    .title h1{
      margin:0;
      font-family: var(--head);
      font-weight: 800;
      letter-spacing:.5px;
      font-size: 20px;
      display:flex;
      align-items:center;
      gap: calc(var(--s)*1);
      color: var(--text);
    }
    .logo-icon{
      width: 24px; height: 24px;
      background: var(--accent);
      mask: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>') no-repeat center;
      mask-size: contain;
      -webkit-mask: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>') no-repeat center;
      -webkit-mask-size: contain;
    }
    .ai-badge {
      font-size: 10px;
      background: rgba(210, 255, 5, 0.15);
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
      font-family: var(--mono);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .subtitle{
      font-size: 12px;
      color: rgba(246,243,234,.60);
      font-family: var(--mono);
      letter-spacing:.2px;
    }

    .controls{
      display:flex;
      gap: calc(var(--s)*1.25);
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .select, .btn{
      border-radius: var(--r2);
      border: 1px solid var(--line);
      background: rgba(26,33,43,.55);
      color: var(--text);
      padding: 10px 14px;
      font-size: 12px;
      cursor:pointer;
      outline:none;
      transition: all .2s ease;
    }
    .select{
      font-family: var(--mono);
      min-width: 160px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
      white-space:nowrap;
      font-weight: 500;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(210,255,5,.4); background: rgba(210,255,5,.08); }
    .btn:active{ transform: translateY(0px) scale(.98); }

    .btn.primary{
      border-color: rgba(210,255,5,.5);
      background: linear-gradient(135deg, rgba(210,255,5,.15), rgba(26,33,43,.6));
      color: #fff;
      box-shadow: 0 4px 12px rgba(210,255,5,.12);
    }
    .btn.primary:hover {
      box-shadow: 0 4px 16px rgba(210,255,5,.25);
    }
    .btn.danger{
        border-color: rgba(255,5,66,.5);
        background: linear-gradient(135deg, rgba(255,5,66,.15), rgba(26,33,43,.6));
    }
    .btn.danger:hover {
        background: rgba(255,5,66,.2);
        box-shadow: 0 4px 16px rgba(255,5,66,.2);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-family: var(--mono);
      font-size: 11px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(26,33,43,.45);
    }
    .pillDot{
      width:8px; height:8px; border-radius:50%;
      background: var(--accent2);
      box-shadow: 0 0 0 4px rgba(83,209,182,.1);
    }
    .pillDot.warn{ background: var(--warm1); box-shadow: 0 0 0 4px rgba(255,206,111,.1); }
    .pillDot.crit{ background: var(--danger); box-shadow: 0 0 0 4px rgba(255,5,66,.15); }

    /* ===== 12-column grid layout ===== */
    .grid12{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: calc(var(--s)*2);
      padding: calc(var(--s)*2) calc(var(--s)*3);
      flex:1;
      min-height:0;
    }

    .panel{
      border-radius: var(--r);
      border: 1px solid var(--line);
      background: var(--glass);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
      transition: border-color 0.3s ease;
    }
    .panel:hover {
        border-color: rgba(210,255,5,.2);
    }
    .panelHead{
      padding: calc(var(--s)*2) calc(var(--s)*2.5);
      border-bottom: 1px solid var(--line2);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: calc(var(--s)*2);
      background: rgba(210,255,5,.02);
    }
    .panelHead h2{
      margin:0;
      font-family: var(--head);
      font-weight: 700;
      font-size: 14px;
      letter-spacing:.5px;
      text-transform: uppercase;
      color: var(--accent);
    }
    .panelHead p{
      margin:6px 0 0;
      color: rgba(246,243,234,.60);
      font-size: 12px;
      line-height:1.4;
    }
    .panelBody{
      padding: calc(var(--s)*2.5);
      overflow:auto;
      min-height:0;
    }

    /* Left KPI column */
    .left{ grid-column: 1 / span 3; }
    .center{ grid-column: 4 / span 6; }
    .right{ grid-column: 10 / span 3; }
    .bottom{ grid-column: 1 / span 12; }

    .kpis{
      display:grid;
      gap: calc(var(--s)*1.5);
    }
    .kpi{
      border-radius: var(--r2);
      border: 1px solid var(--line);
      background: rgba(26,33,43,.4);
      padding: calc(var(--s)*1.5);
      position:relative;
      overflow:hidden;
    }
    .kpi:before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(210,255,5,.05), transparent 80%);
      pointer-events:none;
    }
    .kLabel{
      font-size: 11px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: rgba(246,243,234,.6);
      font-family: var(--head);
      font-weight: 600;
    }
    .kValue{
      margin-top: 6px;
      font-family: var(--mono);
      font-weight: 400;
      font-size: 24px;
      letter-spacing:-0.5px;
    }
    .kValue .highlight-val { color: var(--accent); text-shadow: 0 0 20px rgba(210,255,5,.25); }
    .kMeta{
      margin-top: 8px;
      font-size: 11px;
      color: rgba(246,243,234,.5);
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-family: var(--mono);
    }
    .tag{
      border:1px solid rgba(246,243,234,.1);
      background: rgba(15,19,26,.4);
      padding: 4px 8px;
      border-radius: 6px;
      white-space:nowrap;
      font-size: 10px;
      color: rgba(246,243,234,.8);
    }

    /* Connector list */
    .connList{ margin-top: calc(var(--s)*1.5); display:grid; gap: calc(var(--s)*1); }
    .connRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      border-radius: var(--r2);
      border:1px solid rgba(246,243,234,.08);
      background: rgba(15,19,26,.4);
      font-size: 12px;
      transition: background 0.2s;
    }
    .connRow.malfunction {
        border-color: rgba(255,5,66,.4);
        background: rgba(255,5,66,.08);
    }
    .connLeft{
      display:flex; flex-direction:column; gap:4px;
      min-width:0;
    }
    .connName{
      font-weight: 600;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 220px;
    }
    .connMeta{
      font-family: var(--mono);
      font-size: 10px;
      color: rgba(246,243,234,.5);
    }

    .state{
      display:inline-flex; align-items:center; gap:8px;
      font-family: var(--mono);
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(246,243,234,.1);
      background: rgba(26,33,43,.5);
      white-space:nowrap;
    }

    /* Chart */
    .chartWrap{
      border-radius: var(--r2);
      border:1px solid rgba(246,243,234,.08);
      background: rgba(15,19,26,.3);
      padding: calc(var(--s)*1.5);
      position:relative;
      overflow:hidden;
    }
    canvas{ display:block; width:100%; height:260px; }
    .chartLegend{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      font-family: var(--mono);
      font-size: 10px;
      color: rgba(246,243,234,.5);
    }
    .legendDot{
      width:8px; height:8px; border-radius:2px;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(210,255,5,.4);
      display:inline-block;
      margin-right:8px;
      vertical-align:middle;
    }

    /* Data path */
    .flowWrap{
      margin-top: calc(var(--s)*2);
      border-radius: var(--r2);
      border:1px solid rgba(246,243,234,.08);
      background: rgba(15,19,26,.3);
      padding: calc(var(--s)*1.5);
      position: relative;
    }
    .flowSvg{ width:100%; height:180px; display:block; }
    .node{ fill: rgba(38,48,61,.4); stroke: rgba(246,243,234,.1); stroke-width: 1.5; transition: all 0.3s ease; }
    .node.active{ stroke: var(--accent); filter: drop-shadow(0 0 10px rgba(210,255,5,.15)); }
    .node.warn { stroke: var(--warm0); filter: drop-shadow(0 0 10px rgba(238,213,111,.15)); }
    .node.crit { stroke: var(--danger); filter: drop-shadow(0 0 10px rgba(255,5,66,.2)); }

    .pipe{ stroke: rgba(210,255,5,.15); stroke-width: 2; fill:none; stroke-dasharray: 4 4; }
    .pipe.active { stroke: rgba(210,255,5,.4); stroke-dasharray: none; }

    .flowLabel{ fill: rgba(246,243,234,.9); font-size: 12px; font-family: var(--head); font-weight: 700; text-transform: uppercase; }
    .flowSub{ fill: rgba(246,243,234,.6); font-size: 10px; font-family: var(--mono); }

    .pulse{ fill: var(--accent); opacity:0; filter: drop-shadow(0 0 8px rgba(210,255,5,.5)); }
    .pulse.on{ opacity:1; animation: flowMove 1.5s linear infinite; }

    @keyframes flowMove{
      0%{ offset-distance: 0%; opacity: 0; }
      10%{ opacity: 1; }
      90%{ opacity: 1; }
      100%{ offset-distance: 100%; opacity: 0; }
    }

    /* Actions */
    .actions{ display:grid; gap: calc(var(--s)*1.25); }
    .action{
      border-radius: var(--r2);
      border: 1px solid rgba(246,243,234,.1);
      background: rgba(38,48,61,.3);
      padding: calc(var(--s)*1.5);
      transition: all 0.2s;
    }
    .action:hover {
        background: rgba(38,48,61,.5);
        border-color: rgba(210,255,5,.2);
    }
    .actionTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .actionTitle{ font-weight: 600; letter-spacing:.2px; font-size: 13px; color: #fff; }
    .actionMeta{
      margin-top: 8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      font-family: var(--mono);
      font-size: 10px;
      color: rgba(246,243,234,.6);
    }
    .conf{
      border-color: rgba(210,255,5,.3) !important;
      background: rgba(210,255,5,.1) !important;
      color: rgba(246,243,234,.92);
    }

    .triggers{
      margin-top: calc(var(--s)*1.25);
      display:grid;
      gap: calc(var(--s)*1);
    }
    .triggers .btn{ width:100%; justify-content:space-between; }

    /* Table */
    table{ width:100%; border-collapse:collapse; }
    th,td{
      padding: 12px 10px;
      border-bottom: 1px solid var(--line2);
      font-size: 12px;
      text-align:left;
      vertical-align:top;
    }
    th{
      font-size: 10px;
      text-transform: uppercase;
      color: rgba(246,243,234,.5);
      font-family: var(--head);
      font-weight: 600;
      letter-spacing: 1px;
    }
    td { color: rgba(246,243,234,.8); }

    /* Toasts */
    .toasts{
      position:absolute;
      right: calc(var(--s)*3);
      bottom: calc(var(--s)*3);
      display:flex;
      flex-direction:column;
      gap: calc(var(--s)*1.5);
      pointer-events:none;
      max-width: 400px;
      z-index: 50;
    }
    .toast{
      pointer-events:auto;
      border-radius: var(--r2);
      border:1px solid rgba(246,243,234,.1);
      background: rgba(15,19,26,.85);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      padding: 16px;
      animation: pop .25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border-left: 3px solid var(--accent);
    }
    .toast.crit { border-left-color: var(--danger); }
    .toast.warn { border-left-color: var(--warm0); }

    @keyframes pop{ from{ transform: translateY(12px); opacity:0 } to{ transform: translateY(0); opacity:1 } }
    .toastTitle{ font-weight: 700; font-size: 13px; margin-bottom: 4px;}
    .toastMsg{ font-size: 12px; color: rgba(246,243,234,.7); line-height:1.4; }
    .toastTime{ margin-top: 8px; font-family: var(--mono); font-size: 10px; color: rgba(246,243,234,.4); }

    /* Modal */
    .modalBack{
      position:absolute; inset:0;
      background: rgba(5,7,10,.8);
      display:none;
      align-items:center;
      justify-content:center;
      padding: calc(var(--s)*3);
      z-index: 60;
      backdrop-filter: blur(4px);
    }
    .modalBack.on{ display:flex; }
    .modal{
      width: min(980px, 92vw);
      border-radius: calc(var(--r) + 6px);
      border: 1px solid rgba(246,243,234,.1);
      background: #151a21;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding: calc(var(--s)*2.5);
      border-bottom: 1px solid var(--line2);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background: rgba(210,255,5,.03);
    }
    .modalHead h3{
      margin:0;
      font-family: var(--head);
      font-weight: 700;
      font-size: 16px;
      color: #fff;
    }
    .modalBody{
      padding: calc(var(--s)*3);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: calc(var(--s)*3);
    }
    .mini{
      border-radius: var(--r2);
      border:1px solid rgba(246,243,234,.1);
      background: rgba(26,33,43,.3);
      padding: calc(var(--s)*2);
    }
    .miniTitle{ font-family: var(--mono); font-size:10px; color: rgba(246,243,234,.5); text-transform: uppercase; letter-spacing: 1px;}
    .miniBig{ margin-top: 8px; font-family: var(--head); font-weight: 700; font-size: 18px; color: var(--accent); }
    .progress{
      margin-top: 12px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }
    .progress > div{
      height:100%;
      width:0%;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
      transition: width .25s ease;
    }

    /* Highlight pulse */
    .highlight{
      outline: 2px solid var(--accent);
      box-shadow: 0 0 30px rgba(210,255,5,.2);
      animation: flashBorder 1s infinite alternate;
    }
    @keyframes flashBorder { from{ border-color: rgba(210,255,5,0.2); } to { border-color: rgba(210,255,5,1); } }

    @media (max-width: 1100px){
      body{ align-items:flex-start; }
      .frame{ aspect-ratio:auto; height:auto; min-height:0; }
      .grid12{ grid-template-columns: repeat(1, 1fr); }
      .left,.center,.right,.bottom{ grid-column: 1 / -1; }
      canvas{ height: 220px; }
      .modalBody{ grid-template-columns: 1fr; }
    }

    @media (max-width: 900px){
      .topbar{ flex-direction:column; align-items:flex-start; }
      .title{ min-width:0; }
      .controls{ width:100%; justify-content:flex-start; }
      .controls > *{ flex: 1 1 200px; }
    }
  </style>
</head>

<body>
  <div class="frame">
    <div class="app">

      <!-- ===== TOP BAR ===== -->
      <div class="topbar">
        <div class="title">
          <h1>
            <span class="logo-icon"></span>
            Neurologix AI
            <span class="ai-badge">HUB</span>
          </h1>
          <div class="subtitle" id="subtitle">Smart Lab Integration Monitor · Quality Gate Active</div>
        </div>

        <div class="controls">
          <select class="select" id="siteSel" title="Select site">
            <option>COLLIERY-01</option>
            <option>PLANT-02</option>
            <option>YARD-03</option>
          </select>

          <div class="badge" title="Open alerts by severity">
            <span class="pillDot crit" id="critDot"></span><span id="critCount">0</span>
            <span class="pillDot warn"></span><span id="warnCount">0</span>
            <span class="pillDot"></span><span id="infoCount">0</span>
            <span style="opacity:.6">ALERTS</span>
          </div>

          <button class="btn" id="walkBtn">Walkthrough: OFF</button>
          <button class="btn primary" id="exportBtn">Export Report</button>
        </div>
      </div>

      <!-- ===== MAIN GRID ===== -->
      <div class="grid12">

        <!-- LEFT: KPIs -->
        <section class="panel left" id="leftPanel">
          <div class="panelHead">
            <div>
              <h2>Reality Capture</h2>
              <p>Raw Sensor Streams</p>
            </div>
            <span class="tag" id="connSummary">0/0 online</span>
          </div>
          <div class="panelBody">
            <div class="kpis" id="kpis"></div>
            <div style="margin-top:20px; font-family:var(--head); font-weight:700; font-size:12px; color:rgba(255,255,255,.4); text-transform:uppercase;">Input Connectors</div>
            <div class="connList" id="connList"></div>
          </div>
        </section>

        <!-- CENTER: Chart + Flow -->
        <section class="panel center" id="centerPanel">
          <div class="panelHead">
            <div>
              <h2>Smart Lab Monitor</h2>
              <p>Neurologix AI Quality Gate</p>
            </div>
            <span class="tag" id="trendTag">LIVE</span>
          </div>
          <div class="panelBody">
            <div class="flowWrap">
              <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; margin-bottom:12px;">
                <div style="font-family:var(--head); font-weight:700; font-size:12px; text-transform:uppercase; color:var(--accent);">Data Pipeline Visualization</div>
                <span class="tag" id="flowMeta">Trustworthy Data Only</span>
              </div>

              <svg class="flowSvg" viewBox="0 0 800 120" preserveAspectRatio="xMidYMid meet">
                 <defs>
                   <linearGradient id="pipeGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                     <stop offset="0%" style="stop-color:rgba(210,255,5,0.1)" />
                     <stop offset="50%" style="stop-color:rgba(210,255,5,0.4)" />
                     <stop offset="100%" style="stop-color:rgba(210,255,5,0.1)" />
                   </linearGradient>
                 </defs>

                 <!-- Pipe 1: Sensors -> Lab -->
                 <path class="pipe" id="pipe1" d="M120 60 L 320 60" />

                 <!-- Pipe 2: Lab -> Hub -->
                 <path class="pipe" id="pipe2" d="M480 60 L 680 60" />

                 <!-- Node 1: Sensors -->
                 <g id="nSensors" transform="translate(20, 30)">
                    <rect class="node" rx="12" ry="12" width="100" height="60" />
                    <text class="flowLabel" x="50" y="26" text-anchor="middle">Sensors</text>
                    <text class="flowSub" x="50" y="44" text-anchor="middle">Capture Reality</text>
                 </g>

                 <!-- Node 2: Smart Lab (The Monitor) -->
                 <g id="nSmartLab" transform="translate(320, 15)">
                    <rect class="node" rx="16" ry="16" width="160" height="90" stroke-width="2" />
                    <text class="flowLabel" x="80" y="38" text-anchor="middle" fill="#fff" style="font-size:14px;">Smart Lab</text>
                    <text class="flowSub" x="80" y="60" text-anchor="middle" id="labStatus">NEUROLOGIX AI</text>
                    <rect x="65" y="68" width="30" height="4" fill="var(--accent)" rx="2" style="opacity:0.6" />
                 </g>

                 <!-- Node 3: Smart Hub -->
                 <g id="nSmartHub" transform="translate(680, 30)">
                    <rect class="node" rx="12" ry="12" width="100" height="60" />
                    <text class="flowLabel" x="50" y="26" text-anchor="middle">Smart Hub</text>
                    <text class="flowSub" x="50" y="44" text-anchor="middle">Decisions</text>
                 </g>

                 <!-- Pulse Animations -->
                 <circle class="pulse" id="pulse1" r="5">
                    <animateMotion dur="1.5s" repeatCount="indefinite" path="M120 60 L 320 60" />
                 </circle>
                 <circle class="pulse" id="pulse2" r="5">
                    <animateMotion dur="1.5s" repeatCount="indefinite" begin="0.75s" path="M480 60 L 680 60" />
                 </circle>
              </svg>
            </div>

            <div class="chartWrap" style="margin-top:20px;">
              <canvas id="chart"></canvas>
              <div class="chartLegend">
                <div><span class="legendDot"></span>Integrity Confidence Score</div>
                <div id="chartMeta">p95: -- ms</div>
              </div>
            </div>
          </div>
        </section>

        <!-- RIGHT: Actions -->
        <section class="panel right" id="rightPanel">
          <div class="panelHead">
            <div>
              <h2>Run The Business</h2>
              <p>Actionable Insights</p>
            </div>
            <span class="tag" id="modeTag">HEALTHY</span>
          </div>
          <div class="panelBody">
            <div class="actions" id="actions"></div>

            <div style="margin-top:24px; font-family:var(--head); font-weight:700; font-size:12px; color:rgba(255,255,255,.4); text-transform:uppercase;">Scenarios</div>
            <div class="triggers">
              <button class="btn danger" id="tMalfunction" title="Simulate sensor failure">Simulate Sensor Malfunction <span class="tag">TEST</span></button>
              <button class="btn" id="tDust" title="Simulate environmental exceedance">Dust Exceedance <span class="tag">WARN</span></button>
              <button class="btn primary" id="tCal" title="Open calibration">Calibration <span class="tag">AI</span></button>
            </div>
          </div>
        </section>

        <!-- BOTTOM: Audit log -->
        <section class="panel bottom" id="bottomPanel">
          <div class="panelHead">
            <div>
              <h2>Event Log</h2>
              <p>System Audits & Alerts</p>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn" id="clearAlerts">Acknowledge All</button>
            </div>
          </div>
          <div class="panelBody">
            <table aria-label="Audit log table">
              <thead>
                <tr>
                  <th style="width:140px;">Time</th>
                  <th style="width:180px;">Source</th>
                  <th>Event Description</th>
                  <th style="width:120px;">Status</th>
                </tr>
              </thead>
              <tbody id="logBody"></tbody>
            </table>
          </div>
        </section>

      </div>

      <!-- Toasts -->
      <div class="toasts" id="toasts"></div>

      <!-- Modal -->
      <div class="modalBack" id="modalBack">
        <div class="modal">
          <div class="modalHead">
            <div>
              <h3>Neurologix AI Calibration</h3>
              <div style="margin-top:4px; font-size:12px; color:rgba(255,255,255,.5);">Optimize Data Quality Mappings</div>
            </div>
            <button class="btn" id="closeModal">Close</button>
          </div>

          <div class="modalBody">
            <div class="mini">
              <div class="miniTitle">Optimization Routine</div>
              <div class="miniBig">Drift Correction</div>
              <p style="font-size:12px; color:rgba(255,255,255,.6); margin-top:8px;">
                  Analysis of last 5,000 datapoints suggests a +1.2% bias in dust sensors.
                  Applying correction will restore integrity score > 98.
              </p>
              <div class="progress"><div id="calBar"></div></div>
              <div style="margin-top:10px; font-family:var(--mono); font-size:10px; color:rgba(255,255,255,.5);" id="calMeta">
                Waiting to start...
              </div>
              <div style="margin-top:16px;">
                <button class="btn primary" id="startCal">Execute Calibration</button>
              </div>
            </div>

            <div class="mini">
              <div class="miniTitle">Active Rules</div>
              <div class="miniBig">Normalization v1.3</div>
              <table style="margin-top:12px;">
                <tbody id="rulesBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
(() => {
  /* ===== Neurologix AI Showcase ===== */

  const $ = (s, el=document) => el.querySelector(s);
  const now = () => Date.now();
  const fmt = {
    int: (n) => Math.round(n).toLocaleString(),
    one: (n) => (Math.round(n*10)/10).toLocaleString(),
    time: (d=new Date()) => d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"}),
  };

  // State
  const state = {
    site: "COLLIERY-01",
    malfunctionMode: false,
    malfunctioningConnectorId: null,

    integrity: 97.5,
    epm: 3240,
    dq: 98.2,

    connectors: [
      { id:"c1", name:"Dust Sensor A1", state:"online", val: 12 },
      { id:"c2", name:"Dust Sensor A2", state:"online", val: 11 },
      { id:"c3", name:"Vibration (Mill)", state:"online", val: 0.4 },
      { id:"c4", name:"Temp (Bearing)", state:"online", val: 65 },
    ],

    alerts: [],
    log: [],
    chart: Array.from({length: 60}, () => 95 + Math.random()*4),

    walkthrough: false,
    walkStep: 0,
    walkTimer: null,

    lab: { progress: 0, busy: false }
  };

  // Utils
  function toast(title, msg, type="info"){
    const el = document.createElement("div");
    el.className = `toast ${type}`;
    el.innerHTML = `<div class="toastTitle">${title}</div><div class="toastMsg">${msg}</div><div class="toastTime">${fmt.time()}</div>`;
    $("#toasts").appendChild(el);
    setTimeout(() => { el.style.opacity="0"; el.style.transform="translateY(10px)"; }, 4000);
    setTimeout(() => el.remove(), 4500);
  }

  function addLog(who, event, status){
    state.log.unshift({ time: fmt.time(), who, event, status });
    if(state.log.length > 30) state.log.pop();
    renderLog();
  }

  function addAlert(msg, type="info"){
    state.alerts.push({ msg, type, time: fmt.time() });
    toast(type.toUpperCase(), msg, type);
    addLog("System", msg, "ALERT");
    renderTop();
  }

  // Simulation Logic
  function simulate(){
    // Random fluctuation
    state.epm = 3200 + Math.floor(Math.random()*400);
    state.integrity = Math.min(100, Math.max(80, state.integrity + (Math.random()-0.5)));

    if(state.malfunctionMode){
        // In malfunction mode, integrity is SLIGHTLY affected but maintained by the "Smart Lab" filter
        // If we didn't filter, it would drop hard.
        // We show that we are "holding the line".
        if(state.integrity > 96) state.integrity -= 0.1;

        // Find the bad connector
        const bad = state.connectors.find(c => c.id === state.malfunctioningConnectorId);
        if(bad && bad.state !== "malfunction"){
             bad.state = "malfunction";
             addAlert(`Sensor Malfunction: ${bad.name}. Isolating data stream.`, "crit");
             addLog("Neurologix AI", `Detected anomaly in ${bad.name}. Pattern mismatch. Blocked.`, "PROTECTED");
        }
    } else {
        // Recovery
        state.connectors.forEach(c => {
            if(c.state === "malfunction") c.state = "online";
        });
        if(state.integrity < 97.5) state.integrity += 0.2;
    }

    // Chart update
    state.chart.push(state.integrity);
    state.chart.shift();

    renderAll();
  }

  // Rendering
  function renderTop(){
    const crit = state.alerts.filter(a => a.type==="crit").length;
    const warn = state.alerts.filter(a => a.type==="warn").length;
    $("#critCount").textContent = crit;
    $("#warnCount").textContent = warn;
    $("#infoCount").textContent = state.alerts.filter(a => a.type==="info").length;

    $("#critDot").className = `pillDot ${crit>0?'crit':''}`;

    if(state.malfunctionMode){
        $("#subtitle").textContent = "ALERT: SENSOR MALFUNCTION DETECTED · SMART LAB FILTERING ACTIVE";
        $("#subtitle").style.color = "var(--danger)";
        $("#labStatus").textContent = "FILTERING NOISE";
        $("#labStatus").style.fill = "var(--danger)";
        $("#nSmartLab rect").setAttribute("stroke", "var(--danger)");
    } else {
        $("#subtitle").textContent = "Smart Lab Integration Monitor · Quality Gate Active";
        $("#subtitle").style.color = "rgba(246,243,234,.6)";
        $("#labStatus").textContent = "NEUROLOGIX AI";
        $("#labStatus").style.fill = "rgba(246,243,234,.6)";
        $("#nSmartLab rect").setAttribute("stroke", "rgba(246,243,234,.1)");
        $("#nSmartLab").classList.add("active");
    }
  }

  function renderKpis(){
    // If malfunction, show that we are blocking bad data
    // Valid events = total - bad sensor share (approx 25%)
    const displayEpm = state.malfunctionMode ? Math.round(state.epm * 0.75) : state.epm;

    const kpis = [
      { l:"Integrity Score", v:`${fmt.one(state.integrity)}`, m:"Target: >95.0" },
      { l:"Valid Events / min", v:fmt.int(displayEpm), m: state.malfunctionMode ? "<span style='color:var(--danger)'>~25% Filtered</span>" : "All streams nominal" },
      { l:"Data Quality", v:`${fmt.one(state.dq)}%`, m:"AI Confidence" }
    ];

    $("#kpis").innerHTML = kpis.map(k => `
      <div class="kpi">
        <div class="kLabel">${k.l}</div>
        <div class="kValue"><span class="highlight-val">${k.v}</span></div>
        <div class="kMeta">${k.m}</div>
      </div>
    `).join("");

    const online = state.connectors.filter(c=>c.state!=="malfunction").length;
    $("#connSummary").textContent = `${online}/${state.connectors.length} Active`;

    $("#connList").innerHTML = state.connectors.map(c => `
        <div class="connRow ${c.state==='malfunction'?'malfunction':''}">
            <div class="connLeft">
                <div class="connName">${c.name}</div>
                <div class="connMeta">${c.state==='malfunction' ? 'DATA BLOCKED' : 'Streaming...'}</div>
            </div>
            <div class="state">
                <span class="pillDot ${c.state==='malfunction'?'crit':''}"></span>
                ${c.state.toUpperCase()}
            </div>
        </div>
    `).join("");
  }

  function renderFlow(){
     // Visual logic for flow
     const p1 = $("#pipe1");
     const p2 = $("#pipe2");
     const n1 = $("#nSensors rect");
     const n2 = $("#nSmartLab rect");
     const n3 = $("#nSmartHub rect");

     if(state.malfunctionMode){
         // Sensor node warning
         n1.setAttribute("class", "node crit");
         // Pipe 1 active but maybe warning color? we'll leave as blue/default to show data arriving

         // Lab node working hard (active)
         n2.setAttribute("class", "node active");

         // Pipe 2 is PURE (Blue/Green)
         p2.setAttribute("class", "pipe active");

         // Hub is Safe
         n3.setAttribute("class", "node active");

         $("#flowMeta").textContent = "Filtering Malfunction";
         $("#flowMeta").style.color = "var(--danger)";
     } else {
         n1.setAttribute("class", "node active");
         n2.setAttribute("class", "node active");
         n3.setAttribute("class", "node active");
         p1.setAttribute("class", "pipe active");
         p2.setAttribute("class", "pipe active");
         $("#flowMeta").textContent = "Trustworthy Data Only";
         $("#flowMeta").style.color = "";
     }
  }

  function renderActions(){
      let html = "";
      if(state.malfunctionMode){
          html += `
            <div class="action" style="border-color:var(--danger)">
               <div class="actionTop">
                 <div class="actionTitle" style="color:var(--danger)">Sensor Malfunction Detected</div>
               </div>
               <div class="actionMeta" style="color:#fff">
                 Neurologix AI has isolated <b>${state.connectors.find(c=>c.id===state.malfunctioningConnectorId)?.name}</b>.
                 Dashboards remain operational with partial data.
               </div>
               <div style="margin-top:12px;">
                 <button class="btn primary" onclick="document.dispatchEvent(new CustomEvent('fix-sensor'))">Dispatch Repair Crew</button>
               </div>
            </div>
          `;
      }

      html += `
        <div class="action">
            <div class="actionTitle">Review Daily Mapping Report</div>
            <div class="actionMeta">Confidence: 98% · Owner: System</div>
        </div>
      `;
      $("#actions").innerHTML = html;
  }

  function renderLog(){
      $("#logBody").innerHTML = state.log.map(l => `
        <tr>
            <td style="font-family:var(--mono); color:rgba(255,255,255,.4)">${l.time}</td>
            <td>${l.who}</td>
            <td>${l.event}</td>
            <td><span class="tag">${l.status}</span></td>
        </tr>
      `).join("");
  }

  function drawChart(){
      const ctx = $("#chart").getContext("2d");
      const w = ctx.canvas.width = $("#chart").clientWidth;
      const h = ctx.canvas.height = $("#chart").clientHeight;

      ctx.clearRect(0,0,w,h);

      // Grid
      ctx.strokeStyle = "rgba(255,255,255,0.05)";
      ctx.beginPath();
      for(let i=0; i<w; i+=40){ ctx.moveTo(i,0); ctx.lineTo(i,h); }
      for(let i=0; i<h; i+=40){ ctx.moveTo(0,i); ctx.lineTo(w,i); }
      ctx.stroke();

      // Line
      ctx.strokeStyle = state.malfunctionMode ? "#ff0542" : "#D2FF05";
      ctx.lineWidth = 3;
      ctx.lineJoin = "round";
      ctx.shadowColor = ctx.strokeStyle;
      ctx.shadowBlur = 10;

      ctx.beginPath();
      state.chart.forEach((v, i) => {
          const x = (i / (state.chart.length-1)) * w;
          const y = h - ((v - 80) / 20) * h; // scale 80-100
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
  }

  function renderAll(){
      renderKpis();
      renderFlow();
      renderActions();
      drawChart();
  }

  // Actions
  $("#tMalfunction").addEventListener("click", () => {
      if(state.malfunctionMode) return;
      state.malfunctionMode = true;
      state.malfunctioningConnectorId = "c1"; // Deterministic for demo
      addLog("System", "Simulating sensor hardware failure...", "TEST");
      renderTop();
      renderAll();
  });

  document.addEventListener("fix-sensor", () => {
      addAlert("Maintenance crew dispatched. Sensor repaired.", "info");
      state.malfunctionMode = false;
      state.malfunctioningConnectorId = null;
      renderTop();
      renderAll();
  });

  $("#tDust").addEventListener("click", () => {
      addAlert("Dust levels exceeding threshold (PM10 > 50µg).", "warn");
      state.integrity -= 5;
  });

  $("#tCal").addEventListener("click", () => {
      $("#modalBack").classList.add("on");
      // Mock rules
      $("#rulesBody").innerHTML = `
        <tr><td>raw.dust_val</td><td>payload.pm10</td><td>x * 1.02</td></tr>
        <tr><td>raw.vib_x</td><td>payload.vib</td><td>moving_avg(10)</td></tr>
      `;
  });

  $("#closeModal").addEventListener("click", () => $("#modalBack").classList.remove("on"));

  $("#startCal").addEventListener("click", () => {
      const bar = $("#calBar");
      let w = 0;
      $("#calMeta").textContent = "Calibrating...";
      const t = setInterval(() => {
          w += 5;
          bar.style.width = w+"%";
          if(w>=100){
              clearInterval(t);
              $("#calMeta").textContent = "Complete.";
              addLog("Neurologix AI", "Calibration applied. Integrity restored.", "SUCCESS");
              state.dq += 0.5;
              state.integrity += 1.5;
              setTimeout(() => $("#modalBack").classList.remove("on"), 800);
          }
      }, 50);
  });

  $("#clearAlerts").addEventListener("click", () => {
      state.alerts = [];
      renderTop();
  });

  // Init
  addLog("System", "Neurologix AI Hub initialized.", "READY");
  setInterval(simulate, 1000);
  renderAll();
  renderTop();

})();
</script>
</body>
</html>
