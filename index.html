<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Veralogix — Smart Lab Integration Monitor (Mock Showcase)</title>
  <style>
    :root{
      /* ===== STYLE TOKENS (DO NOT CHANGE) ===== */
      --bg0:#0B0E15;
      --bg1:#1D262B;
      --bg2:#303E47;
      --bg3:#465C6B;

      --text:#F6F3EA;

      --accent:#D2FF05;      /* primary */
      --accent2:#9AD153;     /* secondary */
      --deep:#527D2D;        /* deep green */
      --warm0:#B8901F;       /* warm highlight (rare) */
      --warm1:#EED56F;

      /* System */
      --s:8px;               /* 8pt spacing system */
      --r:18px;              /* radius */
      --r2:14px;

      --line: rgba(246,243,234,.10);
      --line2: rgba(246,243,234,.06);
      --glass: rgba(29,38,43,.52);
      --glass2: rgba(48,62,71,.40);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --head: "Montserrat","Space Grotesk", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --body: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --shadow: 0 14px 34px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--body);
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 22% -10%, rgba(210,255,5,.12), transparent 58%),
        radial-gradient(900px 700px at 80% 0%, rgba(154,209,83,.08), transparent 58%),
        radial-gradient(900px 700px at 70% 120%, rgba(238,213,111,.06), transparent 60%),
        var(--bg0);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(var(--s)*2);
    }

    /* 16:9 frame */
    .frame{
      width: min(1600px, 96vw);
      aspect-ratio: 16 / 9;
      max-height: 92vh;
      border-radius: calc(var(--r) + 6px);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(29,38,43,.55), rgba(11,14,21,.88));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    /* Subtle HUD ticks */
    .frame:before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(90deg, rgba(210,255,5,.06) 1px, transparent 1px) 0 0 / 120px 120px,
        linear-gradient(0deg, rgba(246,243,234,.03) 1px, transparent 1px) 0 0 / 120px 120px;
      opacity:.25;
      pointer-events:none;
      mix-blend-mode: screen;
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      position:relative;
    }

    /* ===== Top bar ===== */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: calc(var(--s)*2);
      padding: calc(var(--s)*2) calc(var(--s)*3);
      border-bottom: 1px solid var(--line2);
      background: rgba(11,14,21,.45);
      backdrop-filter: blur(10px);
    }

    .title{
      display:flex;
      flex-direction:column;
      gap: calc(var(--s)*.5);
      min-width: 320px;
    }
    .title h1{
      margin:0;
      font-family: var(--head);
      font-weight: 900;
      letter-spacing:.2px;
      font-size: 18px;
      display:flex;
      align-items:center;
      gap: calc(var(--s)*1);
    }
    .limecheck{
      width:12px; height:12px;
      border-radius: 4px;
      background: rgba(210,255,5,.16);
      border:1px solid rgba(210,255,5,.45);
      position:relative;
      box-shadow: 0 0 0 6px rgba(210,255,5,.06);
    }
    .limecheck:after{
      content:"";
      position:absolute;
      left:3px; top:3px;
      width:6px; height:3px;
      border-left:2px solid var(--accent);
      border-bottom:2px solid var(--accent);
      transform: rotate(-45deg);
    }
    .subtitle{
      font-size: 12px;
      color: rgba(246,243,234,.72);
      font-family: var(--mono);
      letter-spacing:.2px;
    }

    .controls{
      display:flex;
      gap: calc(var(--s)*1.25);
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .select, .btn{
      border-radius: var(--r2);
      border: 1px solid var(--line);
      background: rgba(29,38,43,.45);
      color: var(--text);
      padding: 10px 12px;
      font-size: 12px;
      cursor:pointer;
      outline:none;
    }
    .select{
      font-family: var(--mono);
      min-width: 160px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(210,255,5,.35); background: rgba(48,62,71,.50); }
    .btn:active{ transform: translateY(0px) scale(.99); }

    .btn.primary{
      border-color: rgba(210,255,5,.45);
      background: linear-gradient(180deg, rgba(210,255,5,.14), rgba(29,38,43,.40));
    }
    .btn.ghost{
      border-color: rgba(246,243,234,.14);
      background: rgba(29,38,43,.35);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-family: var(--mono);
      font-size: 11px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(29,38,43,.38);
    }
    .pillDot{
      width:8px; height:8px; border-radius:50%;
      background: var(--accent2);
      box-shadow: 0 0 0 6px rgba(154,209,83,.08);
    }
    .pillDot.warn{ background: var(--warm1); box-shadow: 0 0 0 6px rgba(238,213,111,.08); }
    .pillDot.crit{ background: var(--warm0); box-shadow: 0 0 0 6px rgba(184,144,31,.10); }

    /* ===== 12-column grid layout ===== */
    .grid12{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: calc(var(--s)*1.5);
      padding: calc(var(--s)*2) calc(var(--s)*3);
      flex:1;
      min-height:0;
    }

    .panel{
      border-radius: var(--r);
      border: 1px solid var(--line);
      background: var(--glass);
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 28px rgba(0,0,0,.30);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .panelHead{
      padding: calc(var(--s)*1.75) calc(var(--s)*2);
      border-bottom: 1px solid var(--line2);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: calc(var(--s)*2);
    }
    .panelHead h2{
      margin:0;
      font-family: var(--head);
      font-weight: 900;
      font-size: 13px;
      letter-spacing:.2px;
    }
    .panelHead p{
      margin:6px 0 0;
      color: rgba(246,243,234,.72);
      font-size: 12px;
      line-height:1.35;
    }
    .panelBody{
      padding: calc(var(--s)*2);
      overflow:auto;
      min-height:0;
    }

    /* Left KPI column */
    .left{ grid-column: 1 / span 3; }
    .center{ grid-column: 4 / span 6; }
    .right{ grid-column: 10 / span 3; }
    .bottom{ grid-column: 1 / span 12; }

    .kpis{
      display:grid;
      gap: calc(var(--s)*1.25);
    }
    .kpi{
      border-radius: var(--r2);
      border: 1px solid var(--line);
      background: rgba(48,62,71,.34);
      padding: calc(var(--s)*1.5);
      position:relative;
      overflow:hidden;
    }
    .kpi:before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(210,255,5,.12), transparent 55%);
      opacity:.35;
      pointer-events:none;
    }
    .kLabel{
      font-size: 11px;
      letter-spacing:.2px;
      color: rgba(246,243,234,.74);
    }
    .kValue{
      margin-top: 8px;
      font-family: var(--head);
      font-weight: 900;
      font-size: 22px;
      letter-spacing:.2px;
    }
    .kValue .lime{ color: var(--accent); text-shadow: 0 0 18px rgba(210,255,5,.18); }
    .kMeta{
      margin-top: 8px;
      font-size: 11px;
      color: rgba(246,243,234,.70);
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-family: var(--mono);
    }
    .tag{
      border:1px solid rgba(246,243,234,.14);
      background: rgba(11,14,21,.28);
      padding: 4px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }

    /* Connector list */
    .connList{ margin-top: calc(var(--s)*1.5); display:grid; gap: calc(var(--s)*1); }
    .connRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      border-radius: var(--r2);
      border:1px solid rgba(246,243,234,.10);
      background: rgba(11,14,21,.28);
      font-size: 12px;
    }
    .connLeft{
      display:flex; flex-direction:column; gap:4px;
      min-width:0;
    }
    .connName{
      font-weight: 650;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 220px;
    }
    .connMeta{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(246,243,234,.70);
    }

    .state{
      display:inline-flex; align-items:center; gap:8px;
      font-family: var(--mono);
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(246,243,234,.14);
      background: rgba(29,38,43,.35);
      white-space:nowrap;
    }

    /* Chart */
    .chartWrap{
      border-radius: var(--r2);
      border:1px solid rgba(246,243,234,.12);
      background: rgba(11,14,21,.28);
      padding: calc(var(--s)*1.5);
      position:relative;
      overflow:hidden;
    }
    canvas{ display:block; width:100%; height:260px; }
    .chartLegend{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(246,243,234,.72);
    }
    .legendDot{
      width:10px; height:10px; border-radius:4px;
      background: rgba(210,255,5,.22);
      border:1px solid rgba(210,255,5,.55);
      box-shadow: 0 0 0 6px rgba(210,255,5,.06);
      display:inline-block;
      margin-right:8px;
      vertical-align:middle;
    }

    /* Data path */
    .flowWrap{
      margin-top: calc(var(--s)*1.5);
      border-radius: var(--r2);
      border:1px solid rgba(246,243,234,.12);
      background: rgba(11,14,21,.24);
      padding: calc(var(--s)*1.5);
    }
    .flowSvg{ width:100%; height:150px; display:block; }
    .node{ fill: rgba(48,62,71,.38); stroke: rgba(246,243,234,.14); stroke-width: 1; }
    .node.active{ stroke: rgba(210,255,5,.50); filter: drop-shadow(0 0 14px rgba(210,255,5,.16)); }
    .pipe{ stroke: rgba(210,255,5,.22); stroke-width: 2.2; fill:none; }
    .flowLabel{ fill: rgba(246,243,234,.88); font-size: 11px; font-family: var(--body); }
    .flowSub{ fill: rgba(246,243,234,.70); font-size: 10px; font-family: var(--mono); }
    .pulse{ fill: rgba(210,255,5,.92); opacity:0; filter: drop-shadow(0 0 10px rgba(210,255,5,.25)); }
    .pulse.on{ opacity:1; animation: pulse 1.4s linear infinite; }
    @keyframes pulse{
      0%{ transform: translateX(0px); opacity:0; }
      10%{ opacity:1; }
      90%{ opacity:1; }
      100%{ transform: translateX(560px); opacity:0; }
    }

    /* Actions */
    .actions{ display:grid; gap: calc(var(--s)*1.25); }
    .action{
      border-radius: var(--r2);
      border: 1px solid rgba(246,243,234,.12);
      background: rgba(48,62,71,.30);
      padding: calc(var(--s)*1.5);
    }
    .actionTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .actionTitle{ font-weight: 800; letter-spacing:.2px; }
    .actionMeta{
      margin-top: 8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(246,243,234,.72);
    }
    .conf{
      border-color: rgba(210,255,5,.35) !important;
      background: rgba(210,255,5,.10) !important;
      color: rgba(246,243,234,.92);
    }

    .triggers{
      margin-top: calc(var(--s)*1.25);
      display:grid;
      gap: calc(var(--s)*1);
    }
    .triggers .btn{ width:100%; justify-content:space-between; }

    /* Table */
    table{ width:100%; border-collapse:collapse; }
    th,td{
      padding: 10px 8px;
      border-bottom: 1px solid var(--line2);
      font-size: 12px;
      text-align:left;
      vertical-align:top;
    }
    th{
      font-size: 11px;
      color: rgba(246,243,234,.70);
      font-family: var(--mono);
      letter-spacing:.2px;
    }

    /* Toasts */
    .toasts{
      position:absolute;
      right: calc(var(--s)*2);
      bottom: calc(var(--s)*2);
      display:flex;
      flex-direction:column;
      gap: calc(var(--s)*1);
      pointer-events:none;
      max-width: 420px;
      z-index: 50;
    }
    .toast{
      pointer-events:auto;
      border-radius: var(--r2);
      border:1px solid rgba(246,243,234,.14);
      background: rgba(29,38,43,.72);
      box-shadow: var(--shadow);
      padding: 12px;
      animation: pop .18s ease-out;
    }
    @keyframes pop{ from{ transform: translateY(8px); opacity:0 } to{ transform: translateY(0); opacity:1 } }
    .toastTitle{ font-weight: 800; }
    .toastMsg{ margin-top: 6px; font-size: 12px; color: rgba(246,243,234,.78); line-height:1.35; }
    .toastTime{ margin-top: 8px; font-family: var(--mono); font-size: 11px; color: rgba(246,243,234,.70); }

    /* Modal (Smart Lab UI mock) */
    .modalBack{
      position:absolute; inset:0;
      background: rgba(11,14,21,.66);
      display:none;
      align-items:center;
      justify-content:center;
      padding: calc(var(--s)*3);
      z-index: 60;
    }
    .modalBack.on{ display:flex; }
    .modal{
      width: min(980px, 92vw);
      border-radius: calc(var(--r) + 6px);
      border: 1px solid rgba(246,243,234,.14);
      background: rgba(29,38,43,.82);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding: calc(var(--s)*2) calc(var(--s)*2.5);
      border-bottom: 1px solid var(--line2);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .modalHead h3{
      margin:0;
      font-family: var(--head);
      font-weight: 900;
      font-size: 14px;
    }
    .modalBody{
      padding: calc(var(--s)*2) calc(var(--s)*2.5);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: calc(var(--s)*2);
    }
    .mini{
      border-radius: var(--r2);
      border:1px solid rgba(246,243,234,.12);
      background: rgba(11,14,21,.26);
      padding: calc(var(--s)*1.5);
    }
    .miniTitle{ font-family: var(--mono); font-size:11px; color: rgba(246,243,234,.72); }
    .miniBig{ margin-top: 8px; font-family: var(--head); font-weight: 900; font-size: 18px; }
    .progress{
      margin-top: 10px;
      height: 10px;
      border-radius: 999px;
      border:1px solid rgba(246,243,234,.12);
      background: rgba(48,62,71,.28);
      overflow:hidden;
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(154,209,83,.85), rgba(210,255,5,.85));
      transition: width .25s ease;
    }

    /* Walkthrough highlight */
    .highlight{
      outline: 2px solid rgba(210,255,5,.55);
      box-shadow: 0 0 0 8px rgba(210,255,5,.08);
    }

    @media (max-width: 1100px){
      body{ align-items:flex-start; }
      .frame{ aspect-ratio:auto; height:auto; }
      .grid12{ grid-template-columns: repeat(1, 1fr); }
      .left,.center,.right,.bottom{ grid-column: 1 / -1; }
      canvas{ height: 220px; }
      .modalBody{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="frame">
    <div class="app">

      <!-- ===== TOP BAR ===== -->
      <div class="topbar">
        <div class="title">
          <h1><span class="limecheck"></span><span id="moduleTitle">Smart Lab Integration Monitor</span></h1>
          <div class="subtitle" id="subtitle">SITE: COLLIERY-01 · MODE: HEALTHY · MAPPING: v1.3</div>
        </div>

        <div class="controls">
          <select class="select" id="siteSel" title="Select site">
            <option>COLLIERY-01</option>
            <option>PLANT-02</option>
            <option>YARD-03</option>
          </select>

          <select class="select" id="rangeSel" title="Select date range">
            <option value="24h">Last 24h</option>
            <option value="7d">Last 7d</option>
            <option value="30d">Last 30d</option>
          </select>

          <div class="badge" title="Open alerts by severity">
            <span class="pillDot crit" id="critDot"></span><span id="critCount">0</span>
            <span class="pillDot warn"></span><span id="warnCount">0</span>
            <span class="pillDot"></span><span id="infoCount">0</span>
            <span style="opacity:.8">Open Alerts</span>
          </div>

          <button class="btn ghost" id="walkBtn" title="Auto-cycles key scenarios">Walkthrough: OFF</button>
          <button class="btn primary" id="exportBtn" title="Downloads last 50 events + current KPIs (demo)">Export Audit Pack</button>
        </div>
      </div>

      <!-- ===== MAIN GRID ===== -->
      <div class="grid12">

        <!-- LEFT: KPIs -->
        <section class="panel left" id="leftPanel">
          <div class="panelHead">
            <div>
              <h2>KPIs</h2>
              <p>Glanceable, measurable, audit-safe.</p>
            </div>
            <span class="tag" id="clock">--:--:--</span>
          </div>
          <div class="panelBody">
            <div class="kpis" id="kpis"></div>

            <div style="margin-top:calc(var(--s)*2); display:flex; justify-content:space-between; gap:10px; align-items:center;">
              <div style="font-family:var(--head); font-weight:900; font-size:13px;">Connector Status</div>
              <span class="tag" id="connSummary">0/0 online</span>
            </div>
            <div class="connList" id="connList"></div>
          </div>
        </section>

        <!-- CENTER: Chart + Flow -->
        <section class="panel center" id="centerPanel">
          <div class="panelHead">
            <div>
              <h2>Integrity Trend</h2>
              <p>Composite score from DQ, latency, loss, and mapping confidence.</p>
            </div>
            <span class="tag" id="trendTag">live · 1s</span>
          </div>
          <div class="panelBody">
            <div class="chartWrap">
              <canvas id="chart" aria-label="Integrity trend chart"></canvas>
              <div class="chartLegend">
                <div><span class="legendDot"></span>Integrity score (0–100)</div>
                <div id="chartMeta">p95: -- ms · events/min: --</div>
              </div>
            </div>

            <div class="flowWrap" style="margin-top:calc(var(--s)*2);">
              <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                <div style="font-family:var(--head); font-weight:900; font-size:13px;">Data Path</div>
                <span class="tag" id="flowMeta">Sensor → Smart Lab</span>
              </div>

              <svg class="flowSvg" viewBox="0 0 860 150" preserveAspectRatio="xMidYMid meet" aria-label="Data path visualization">
                <path class="pipe" d="M120 60 C 190 60, 210 60, 280 60" />
                <path class="pipe" d="M330 60 C 400 60, 420 60, 490 60" />
                <path class="pipe" d="M540 60 C 610 60, 630 60, 700 60" />

                <rect class="node" id="nPhysical" x="20" y="30" rx="14" ry="14" width="100" height="60"/>
                <text class="flowLabel" x="70" y="56" text-anchor="middle">Physical</text>
                <text class="flowSub" x="70" y="76" text-anchor="middle">Sensors</text>

                <rect class="node" id="nEdge" x="280" y="30" rx="14" ry="14" width="100" height="60"/>
                <text class="flowLabel" x="330" y="56" text-anchor="middle">Edge</text>
                <text class="flowSub" x="330" y="76" text-anchor="middle">Gateways</text>

                <rect class="node" id="nNetwork" x="490" y="30" rx="14" ry="14" width="100" height="60"/>
                <text class="flowLabel" x="540" y="56" text-anchor="middle">Network</text>
                <text class="flowSub" x="540" y="76" text-anchor="middle" id="netState">ONLINE</text>

                <rect class="node" id="nSmartLab" x="700" y="30" rx="14" ry="14" width="140" height="60"/>
                <text class="flowLabel" x="770" y="54" text-anchor="middle">Smart Lab</text>
                <text class="flowSub" x="770" y="76" text-anchor="middle" id="mapVersion">v1.3</text>

                <circle class="pulse" id="pulseA" cx="120" cy="60" r="5"></circle>
              </svg>

              <div style="margin-top:calc(var(--s)*1.25); display:flex; gap:10px; flex-wrap:wrap; font-family:var(--mono); font-size:11px; color:rgba(246,243,234,.72);">
                <span class="tag" id="bufferTag">Edge buffer: -- msgs</span>
                <span class="tag" id="dqTag">DQ: --%</span>
                <span class="tag" id="lossTag">Loss: --%</span>
              </div>
            </div>
          </div>
        </section>

        <!-- RIGHT: Actions -->
        <section class="panel right" id="rightPanel">
          <div class="panelHead">
            <div>
              <h2>Recommended Actions</h2>
              <p>Owner, impact, confidence. No vibes.</p>
            </div>
            <span class="tag" id="modeTag">MODE: HEALTHY</span>
          </div>
          <div class="panelBody">
            <div class="actions" id="actions"></div>

            <div style="margin-top:calc(var(--s)*2); display:flex; justify-content:space-between; gap:10px; align-items:center;">
              <div style="font-family:var(--head); font-weight:900; font-size:13px;">EXCO Triggers</div>
              <span class="tag">demo</span>
            </div>
            <div class="triggers">
              <button class="btn" id="tOutage" title="Simulate uplink outage and buffering">Network Outage <span class="tag">CRIT</span></button>
              <button class="btn" id="tDust" title="Simulate environmental exceedance">Dust Spike <span class="tag">WARN</span></button>
              <button class="btn primary" id="tCal" title="Open Smart Lab calibration workflow">Run Calibration <span class="tag">LAB</span></button>
            </div>

            <div style="margin-top:calc(var(--s)*2);">
              <button class="btn ghost" id="openLab" title="Operator-facing Smart Lab UI mock">Open Smart Lab UI</button>
            </div>
          </div>
        </section>

        <!-- BOTTOM: Audit log -->
        <section class="panel bottom" id="bottomPanel">
          <div class="panelHead">
            <div>
              <h2>Audit / Event Log</h2>
              <p>Timestamp · Asset/Operator · Event · Status</p>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              <select class="select" id="logFilter" title="Filter by severity">
                <option value="all">Severity: All</option>
                <option value="crit">Severity: Critical</option>
                <option value="warn">Severity: Warning</option>
                <option value="info">Severity: Info</option>
              </select>
              <button class="btn" id="clearAlerts" title="Marks all alerts resolved (demo)">Resolve All</button>
            </div>
          </div>
          <div class="panelBody">
            <table aria-label="Audit log table">
              <thead>
                <tr>
                  <th style="width:170px;">Timestamp</th>
                  <th style="width:220px;">Asset / Operator</th>
                  <th>Event</th>
                  <th style="width:140px;">Status</th>
                </tr>
              </thead>
              <tbody id="logBody"></tbody>
            </table>
          </div>
        </section>

      </div>

      <!-- Toasts -->
      <div class="toasts" id="toasts"></div>

      <!-- Smart Lab Modal -->
      <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-label="Smart Lab UI">
        <div class="modal">
          <div class="modalHead">
            <div>
              <h3>Smart Lab UI (Mock)</h3>
              <div style="margin-top:6px; font-family:var(--mono); font-size:11px; color:rgba(246,243,234,.72);" id="modalSub">
                Provision → Calibrate → Publish Mapping → Improve DQ
              </div>
            </div>
            <button class="btn" id="closeModal">Close</button>
          </div>

          <div class="modalBody">
            <div class="mini">
              <div class="miniTitle">Calibration pack</div>
              <div class="miniBig">Dust + Belt Scale Verification</div>
              <div style="margin-top:10px; color:rgba(246,243,234,.78); font-size:12px; line-height:1.35;">
                Produces a mapping bump and improves DQ. Adds a signed audit entry (demo).
              </div>

              <div class="progress"><div id="calBar"></div></div>
              <div style="margin-top:10px; font-family:var(--mono); font-size:11px; color:rgba(246,243,234,.72);" id="calMeta">
                step=1 · progress=0% · result=pending
              </div>

              <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn primary" id="startCal">Start calibration</button>
                <button class="btn ghost" id="publishMap">Publish mapping</button>
              </div>
            </div>

            <div class="mini">
              <div class="miniTitle">Mapping rules (mock)</div>
              <div class="miniBig">Normalization</div>
              <table style="margin-top:12px; width:100%; border-collapse:collapse;">
                <thead>
                  <tr>
                    <th style="text-align:left; font-size:11px; font-family:var(--mono); color:rgba(246,243,234,.72); border-bottom:1px solid rgba(246,243,234,.08); padding:8px 6px;">Raw</th>
                    <th style="text-align:left; font-size:11px; font-family:var(--mono); color:rgba(246,243,234,.72); border-bottom:1px solid rgba(246,243,234,.08); padding:8px 6px;">Maps to</th>
                    <th style="text-align:left; font-size:11px; font-family:var(--mono); color:rgba(246,243,234,.72); border-bottom:1px solid rgba(246,243,234,.08); padding:8px 6px;">Transform</th>
                  </tr>
                </thead>
                <tbody id="rulesBody"></tbody>
              </table>

              <div style="margin-top:12px; font-family:var(--mono); font-size:11px; color:rgba(246,243,234,.72);">
                Current mapping: <span class="tag" id="mapTag">v1.3</span>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
(() => {
  /* ===== Mock Showcase App (Offline) =====
     Demonstrates: connectors → sensor streams → data path → alerts → actions → audit log → Smart Lab.
     No external libs. Realistic-but-fabricated data. */

  const MODULE_NAME = "Smart Lab Integration Monitor";

  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
  const clamp = (n,a,b) => Math.max(a, Math.min(b,n));
  const now = () => Date.now();

  const fmt = {
    int: (n) => Math.round(n).toLocaleString(),
    one: (n) => (Math.round(n*10)/10).toLocaleString(),
    pct: (n) => `${(Math.round(n*10)/10)}%`,
    time: (d=new Date()) => d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"}),
    ts: (d=new Date()) => d.toLocaleString([], {year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit"})
  };

  // deterministic-ish random
  let seed = 0xC0FFEE;
  const rand = () => {
    seed ^= seed << 13; seed ^= seed >>> 17; seed ^= seed << 5;
    return (seed >>> 0) / 4294967296;
  };
  const noise = (n=1) => (rand()*2 - 1) * n;

  // ===== State =====
  const state = {
    site: "COLLIERY-01",
    range: "24h",

    network: { state: "online", p95: 160, loss: 0.2, lastFlip: now() },

    mapping: { version: "v1.3", confidence: 92 },

    connectors: [
      { id:"gw-lora-01", name:"LoRaWAN Gateway", state:"online", buffer: 0, err: 0.3 },
      { id:"gw-plc-01",  name:"PLC/SCADA Gateway", state:"online", buffer: 0, err: 0.2 },
      { id:"trk-045",    name:"Truck Telemetry (TRK-045)", state:"online", buffer: 0, err: 0.4 },
      { id:"wx-001",     name:"Weather Station", state:"online", buffer: 0, err: 0.1 },
    ],

    // simulated metrics
    epm: 2400,       // events per min
    dq: 94.0,        // %
    integrity: 93.0, // 0-100
    edgeBuffer: 0,

    alerts: [],      // {id, ts, sev: crit|warn|info, msg, open}
    log: [],         // {ts, who, event, status, sev}

    chart: Array.from({length: 90}, (_,i) => 92 + Math.sin(i/8)*1.8 + noise(0.7)),

    walkthrough: false,
    walkStep: 0,
    walkTimer: null,

    smartlab: { progress: 0, step: 1, result: "pending" },

    rules: [
      { raw:"payload.tempF", to:"data.tempC", tx:"(F − 32) × 5/9" },
      { raw:"payload.pressPsi", to:"data.pressKpa", tx:"psi × 6.89476" },
      { raw:"payload.deviceId", to:"sourceId", tx:"pass-through" }
    ]
  };

  // ===== UI refs =====
  $("#moduleTitle").textContent = MODULE_NAME;

  // ===== Helpers =====
  const id = () => Math.random().toString(16).slice(2);

  function toast(title, msg){
    const wrap = $("#toasts");
    const el = document.createElement("div");
    el.className = "toast";
    el.innerHTML = `
      <div class="toastTitle">${title}</div>
      <div class="toastMsg">${msg}</div>
      <div class="toastTime">${fmt.time()}</div>
    `;
    wrap.appendChild(el);
    setTimeout(() => {
      el.style.opacity = "0";
      el.style.transform = "translateY(6px)";
      el.style.transition = "opacity .22s, transform .22s";
    }, 5200);
    setTimeout(() => el.remove(), 5600);
  }

  function addLog({who, event, status, sev="info"}){
    state.log.unshift({ ts: fmt.ts(), who, event, status, sev });
    if(state.log.length > 120) state.log.pop();
  }

  function addAlert(sev, msg){
    const a = { id: id(), ts: now(), sev, msg, open: true };
    state.alerts.unshift(a);
    addLog({
      who: sev === "crit" ? "Network/Edge" : sev === "warn" ? "Ops/HSE" : "System",
      event: msg,
      status: "OPEN",
      sev
    });
    toast(`${sev.toUpperCase()} Alert`, msg);
  }

  function resolveAll(){
    state.alerts.forEach(a => a.open = false);
    addLog({ who:"System", event:"All alerts resolved (demo)", status:"CLOSED", sev:"info" });
    toast("Resolved", "All alerts marked resolved (demo).");
  }

  function sevCounts(){
    const open = state.alerts.filter(a => a.open);
    return {
      crit: open.filter(a => a.sev==="crit").length,
      warn: open.filter(a => a.sev==="warn").length,
      info: open.filter(a => a.sev==="info").length
    };
  }

  function systemMode(){
    const c = sevCounts();
    if(state.network.state === "offline" || c.crit > 0) return "INCIDENT";
    if(state.network.state === "degraded" || c.warn > 0) return "DEGRADED";
    return "HEALTHY";
  }

  // ===== Simulations =====
  function simulateNetwork(){
    const n = state.network;

    if(n.state === "offline"){
      n.p95 = clamp(n.p95 + 80 + Math.abs(noise(40)), 650, 2400);
      n.loss = clamp(n.loss + 1.4 + Math.abs(noise(.8)), 2.0, 18.0);
    } else if(n.state === "degraded"){
      n.p95 = clamp(320 + Math.abs(noise(120)), 220, 1100);
      n.loss = clamp(0.9 + Math.abs(noise(.6)), 0.5, 6.0);
    } else {
      n.p95 = clamp(160 + noise(25), 90, 240);
      n.loss = clamp(0.2 + Math.abs(noise(.18)), 0.05, 1.0);
    }
  }

  function simulateConnectors(){
    // buffer behaviour
    state.connectors.forEach(c => {
      if(state.network.state === "offline"){
        c.buffer = clamp(c.buffer + Math.round(40 + rand()*80), 0, 25000);
        c.state = (rand() < 0.06) ? "degraded" : c.state;
      } else if(state.network.state === "degraded"){
        c.buffer = clamp(c.buffer + Math.round(rand()*30), 0, 16000);
        c.state = (rand() < 0.03) ? "degraded" : (c.state === "offline" ? "degraded" : c.state);
      } else {
        // flush
        c.buffer = clamp(c.buffer - Math.round(140 + rand()*260), 0, 25000);
        if(c.buffer === 0 && c.state !== "offline") c.state = "online";
      }

      // occasional blips
      if(state.network.state !== "offline" && rand() < 0.007){
        c.state = "offline";
        addAlert("warn", `${c.name} missed heartbeat > 60s`);
      }
      if(c.state === "offline" && rand() < 0.10 && state.network.state !== "offline"){
        c.state = "degraded";
        addLog({ who:c.name, event:"Reconnected (degraded)", status:"TRACKING", sev:"info" });
      }
    });

    state.edgeBuffer = state.connectors.reduce((sum,c)=>sum + c.buffer, 0);
  }

  function simulatePipeline(){
    const onlineCount = state.connectors.filter(c => c.state !== "offline").length;
    const total = state.connectors.length;

    const connectorFactor = onlineCount / total;
    const netPenalty = state.network.state === "offline" ? 0.05 : state.network.state === "degraded" ? 0.65 : 1.0;
    const backlogBoost = (state.network.state === "online" && state.edgeBuffer > 800) ? 1.35 : 1.0;

    const base = 2400 + noise(140);
    state.epm = clamp(base * connectorFactor * netPenalty * backlogBoost, 0, 9200);

    // DQ trends
    let dq = state.dq + noise(0.12);
    if(state.network.state === "offline") dq -= 0.18;
    if(state.connectors.some(c => c.state==="offline")) dq -= 0.12;
    if(state.smartlab.result === "success") dq += 0.06;

    state.dq = clamp(dq, 82, 99);

    // Integrity score
    const latencyPenalty = clamp((state.network.p95 - 180) / 18, 0, 25);
    const lossPenalty = clamp(state.network.loss * 1.2, 0, 25);
    const bufferPenalty = clamp(state.edgeBuffer / 1800, 0, 18);
    const dqPenalty = clamp((94 - state.dq) * 1.1, 0, 22);

    state.integrity = clamp(98 - latencyPenalty - lossPenalty - bufferPenalty - dqPenalty, 40, 99);

    // chart shift
    state.chart.push(state.integrity + noise(0.35));
    if(state.chart.length > 90) state.chart.shift();

    // detection rules (alerts)
    // CRIT: uplink down > ~30s simulated by offline state
    if(state.network.state === "offline" && rand() < 0.08){
      const existing = state.alerts.some(a => a.open && a.sev==="crit" && a.msg.includes("Uplink down"));
      if(!existing) addAlert("crit", "Uplink down > 30s. Edge buffering active.");
    }
    // WARN: integrity drift
    if(state.integrity < 85 && rand() < 0.06){
      addAlert("warn", `Integrity drift: score ${fmt.one(state.integrity)}. Recommend calibration + mapping review.`);
    }
    // INFO: backlog flush
    if(state.network.state === "online" && state.edgeBuffer > 1500 && rand() < 0.05){
      addAlert("info", "Backlog flush active. Events/min spike expected during reconciliation.");
    }
  }

  // ===== Render =====
  function renderKpis(){
    const kpis = [
      {
        label: "Integrity Score",
        value: `<span class="lime">${fmt.one(state.integrity)}</span>`,
        meta: `0–100 · p95 ${fmt.int(state.network.p95)} ms`,
        tip: "Composite of DQ, latency, loss, and mapping confidence."
      },
      {
        label: "Events Normalized / min",
        value: `<span class="lime">${fmt.int(state.epm)}</span>`,
        meta: `post-clean · ${state.range}`,
        tip: "Event throughput after normalization."
      },
      {
        label: "Data Quality",
        value: `<span class="lime">${fmt.one(state.dq)}%</span>`,
        meta: `mapping ${state.mapping.version}`,
        tip: "DQ reflects mapping + calibration confidence."
      },
      {
        label: "Edge Buffer Depth",
        value: `<span class="lime">${fmt.int(state.edgeBuffer)}</span>`,
        meta: `msgs queued`,
        tip: "Queued messages awaiting uplink flush."
      }
    ];

    $("#kpis").innerHTML = kpis.map(k => `
      <div class="kpi" title="${k.tip}">
        <div class="kLabel">${k.label}</div>
        <div class="kValue">${k.value}</div>
        <div class="kMeta"><span class="tag">${k.meta}</span></div>
      </div>
    `).join("");
  }

  function renderConnectors(){
    const online = state.connectors.filter(c => c.state==="online").length;
    $("#connSummary").textContent = `${online}/${state.connectors.length} online`;

    $("#connList").innerHTML = state.connectors.map(c => {
      const st = c.state.toUpperCase();
      const dotClass = c.state === "online" ? "" : c.state === "degraded" ? "warn" : "crit";
      const buf = fmt.int(c.buffer);
      return `
        <div class="connRow">
          <div class="connLeft">
            <div class="connName">${c.name}</div>
            <div class="connMeta">buffer ${buf} · err ${fmt.one(c.err)}%</div>
          </div>
          <div class="state">
            <span class="pillDot ${dotClass}"></span>${st}
          </div>
        </div>
      `;
    }).join("");
  }

  function renderTop(){
    $("#clock").textContent = fmt.time();

    $("#siteSel").value = state.site;
    $("#rangeSel").value = state.range;

    const counts = sevCounts();
    $("#critCount").textContent = counts.crit;
    $("#warnCount").textContent = counts.warn;
    $("#infoCount").textContent = counts.info;

    // System mode + subtitle
    const mode = systemMode();
    $("#modeTag").textContent = `MODE: ${mode}`;
    $("#subtitle").textContent = `SITE: ${state.site} · MODE: ${mode} · MAPPING: ${state.mapping.version}`;

    // flow meta
    $("#netState").textContent = state.network.state.toUpperCase();
    $("#mapVersion").textContent = state.mapping.version;

    $("#bufferTag").textContent = `Edge buffer: ${fmt.int(state.edgeBuffer)} msgs`;
    $("#dqTag").textContent = `DQ: ${fmt.one(state.dq)}%`;
    $("#lossTag").textContent = `Loss: ${fmt.one(state.network.loss)}%`;

    // chart meta
    $("#chartMeta").textContent = `p95: ${fmt.int(state.network.p95)} ms · events/min: ${fmt.int(state.epm)}`;

    // node active states
    $("#nPhysical").classList.add("active");
    $("#nEdge").classList.add("active");
    $("#nSmartLab").classList.add("active");
    $("#nNetwork").classList.toggle("active", state.network.state !== "offline");

    // crit dot in badge
    $("#critDot").className = "pillDot " + (counts.crit > 0 || state.network.state==="offline" ? "crit" : "");
  }

  function renderActions(){
    // derive actions from state
    const mode = systemMode();
    const actions = [];

    if(state.network.state === "offline"){
      actions.push({
        title: "Restore uplink + confirm failover",
        owner: "Network Lead",
        impact: "Reduce buffer growth (~R 45k/day risk avoided, demo)",
        conf: 92
      });
    } else if(state.network.state === "degraded"){
      actions.push({
        title: "Throttle non-critical telemetry",
        owner: "Ops Tech",
        impact: "Stabilize p95 latency to < 300ms",
        conf: 84
      });
    } else {
      actions.push({
        title: "Verify Smart Lab pack schedule",
        owner: "Smart Lab",
        impact: "Maintain DQ ≥ 94% (reduces false alarms)",
        conf: 78
      });
    }

    if(state.integrity < 88){
      actions.push({
        title: "Run calibration + publish mapping",
        owner: "Smart Lab",
        impact: "Recover integrity score by +4 to +8 (demo)",
        conf: 86
      });
    } else {
      actions.push({
        title: "Review top anomalies (last 60 min)",
        owner: "Shift Supervisor",
        impact: "Prevent drift from becoming downtime",
        conf: 73
      });
    }

    actions.push({
      title: "Export audit pack for governance",
      owner: "Ops Analyst",
      impact: "Signed evidence: KPIs + events + mapping version",
      conf: 95
    });

    const top3 = actions.slice(0,3);

    $("#actions").innerHTML = top3.map(a => `
      <div class="action">
        <div class="actionTop">
          <div>
            <div class="actionTitle">${a.title}</div>
            <div class="actionMeta">
              <span class="tag">Owner: ${a.owner}</span>
              <span class="tag">Impact: ${a.impact}</span>
              <span class="tag conf" title="Rule-based confidence (demo). Not an ML probability.">Confidence: ${a.conf}%</span>
            </div>
          </div>
        </div>
      </div>
    `).join("");
  }

  function renderLog(){
    const filter = $("#logFilter").value;
    const rows = (filter === "all")
      ? state.log
      : state.log.filter(r => r.sev === filter);

    $("#logBody").innerHTML = (rows.length ? rows.slice(0, 50) : [{
      ts: fmt.ts(), who:"System", event:"No events recorded yet.", status:"—", sev:"info"
    }]).map(r => `
      <tr>
        <td style="font-family:var(--mono);">${r.ts}</td>
        <td>${r.who}</td>
        <td>${r.event}</td>
        <td><span class="tag">${r.status}</span></td>
      </tr>
    `).join("");
  }

  // ===== Chart drawing (lime line + dark gridlines) =====
  function drawChart(){
    const canvas = $("#chart");
    const ctx = canvas.getContext("2d");

    const dpr = window.devicePixelRatio || 1;
    const w = canvas.clientWidth * dpr;
    const h = canvas.clientHeight * dpr;
    canvas.width = w;
    canvas.height = h;

    ctx.clearRect(0,0,w,h);

    // gridlines (dark)
    ctx.strokeStyle = "rgba(246,243,234,.08)";
    ctx.lineWidth = 1 * dpr;
    const gx = 10, gy = 6;
    for(let i=1;i<gx;i++){
      const x = (w/gx)*i;
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
    }
    for(let j=1;j<gy;j++){
      const y = (h/gy)*j;
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
    }

    const data = state.chart;
    const min = 60, max = 100; // integrity score domain

    const X = (i) => (i/(data.length-1)) * (w - 20*dpr) + 10*dpr;
    const Y = (v) => {
      const t = (v - min) / (max - min);
      return (h - 10*dpr) - t*(h - 20*dpr);
    };

    // lime line
    ctx.strokeStyle = "rgba(210,255,5,.95)";
    ctx.shadowColor = "rgba(210,255,5,.20)";
    ctx.shadowBlur = 18 * dpr;
    ctx.lineWidth = 2.4 * dpr;
    ctx.beginPath();
    data.forEach((v,i) => {
      const x = X(i), y = Y(v);
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();
    ctx.shadowBlur = 0;

    // last point
    const lx = X(data.length-1), ly = Y(data[data.length-1]);
    ctx.fillStyle = "rgba(210,255,5,.95)";
    ctx.beginPath(); ctx.arc(lx, ly, 3.6*dpr, 0, Math.PI*2); ctx.fill();
  }

  // ===== Flow pulse =====
  function pulse(on){
    const p = $("#pulseA");
    p.classList.toggle("on", on);
  }

  // ===== Smart Lab modal =====
  function renderRules(){
    $("#rulesBody").innerHTML = state.rules.map(r => `
      <tr>
        <td style="padding:8px 6px; border-bottom:1px solid rgba(246,243,234,.06); font-family:var(--mono); font-size:11px; color:rgba(246,243,234,.82);">${r.raw}</td>
        <td style="padding:8px 6px; border-bottom:1px solid rgba(246,243,234,.06); font-family:var(--mono); font-size:11px; color:rgba(246,243,234,.82);">${r.to}</td>
        <td style="padding:8px 6px; border-bottom:1px solid rgba(246,243,234,.06); font-family:var(--mono); font-size:11px; color:rgba(246,243,234,.72);">${r.tx}</td>
      </tr>
    `).join("");
    $("#mapTag").textContent = state.mapping.version;
  }

  function openModal(){
    $("#modalBack").classList.add("on");
    renderRules();
    $("#calBar").style.width = `${state.smartlab.progress}%`;
    $("#calMeta").textContent = `step=${state.smartlab.step} · progress=${Math.round(state.smartlab.progress)}% · result=${state.smartlab.result}`;
  }
  function closeModal(){
    $("#modalBack").classList.remove("on");
  }

  function startCalibration(){
    state.smartlab.progress = 0;
    state.smartlab.step = 1;
    state.smartlab.result = "pending";
    toast("Smart Lab", "Calibration started (demo).");
    addLog({ who:"Smart Lab", event:"Calibration started: Dust + Belt Scale Verification", status:"RUNNING", sev:"info" });

    const timer = setInterval(() => {
      state.smartlab.progress = clamp(state.smartlab.progress + 10 + rand()*14, 0, 100);
      state.smartlab.step = state.smartlab.progress < 55 ? 1 : 2;

      $("#calBar").style.width = `${state.smartlab.progress}%`;
      $("#calMeta").textContent = `step=${state.smartlab.step} · progress=${Math.round(state.smartlab.progress)}% · result=${state.smartlab.result}`;

      if(state.smartlab.progress >= 100){
        clearInterval(timer);
        state.smartlab.step = 3;
        state.smartlab.result = "success";
        state.dq = clamp(state.dq + 1.2, 82, 99);
        state.integrity = clamp(state.integrity + 3.5, 40, 99);

        addLog({ who:"Smart Lab", event:"Calibration complete. Reference readings verified.", status:"DONE", sev:"info" });
        addAlert("info", "Calibration applied. DQ and integrity improved (demo).");
        renderAll();
      }
    }, 650);
  }

  function publishMapping(){
    const bump = 4 + Math.floor(rand()*4);
    state.mapping.version = `v1.${bump}`;
    state.mapping.confidence = clamp(state.mapping.confidence + 2, 70, 98);
    state.dq = clamp(state.dq + 0.6, 82, 99);
    addLog({ who:"Smart Lab", event:`Mapping published: ${state.mapping.version}`, status:"PUBLISHED", sev:"info" });
    toast("Mapping Published", `Published ${state.mapping.version} to Hub (demo).`);
    renderRules();
    renderAll();
  }

  // ===== Triggers =====
  function triggerOutage(){
    state.network.state = "offline";
    state.network.lastFlip = now();
    addAlert("crit", "Uplink down. Store-and-forward buffering engaged.");
    state.connectors.forEach(c => c.state = (c.state==="offline" ? "offline" : "degraded"));
    pulse(true); setTimeout(() => pulse(false), 2400);
    highlight("center");
    renderAll();
  }

  function triggerDust(){
    addAlert("warn", "PM10 exceedance detected. Recommend water carts + speed limit (demo).");
    addLog({ who:"HSE", event:"Mitigation playbook surfaced for dust exceedance", status:"SUGGESTED", sev:"warn" });
    state.integrity = clamp(state.integrity - 3.2, 40, 99);
    pulse(true); setTimeout(() => pulse(false), 2400);
    highlight("right");
    renderAll();
  }

  function highlight(which){
    ["leftPanel","centerPanel","rightPanel","bottomPanel"].forEach(id => $("#"+id).classList.remove("highlight"));
    if(which==="left") $("#leftPanel").classList.add("highlight");
    if(which==="center") $("#centerPanel").classList.add("highlight");
    if(which==="right") $("#rightPanel").classList.add("highlight");
    if(which==="bottom") $("#bottomPanel").classList.add("highlight");
    setTimeout(() => ["leftPanel","centerPanel","rightPanel","bottomPanel"].forEach(id => $("#"+id).classList.remove("highlight")), 4200);
  }

  // ===== Walkthrough =====
  const walk = [
    { name:"Baseline", run:() => {
      state.network.state = "online";
      addAlert("info", "Walkthrough: baseline healthy state (demo).");
      highlight("left");
    }},
    { name:"Dust Spike", run:() => triggerDust() },
    { name:"Network Outage", run:() => triggerOutage() },
    { name:"Recovery + Flush", run:() => {
      state.network.state = "online";
      addAlert("info", "Network recovered. Backlog flush active (demo).");
      state.connectors.forEach(c => c.state = "online");
      highlight("center");
    }},
    { name:"Smart Lab Calibration", run:() => { openModal(); startCalibration(); highlight("right"); }}
  ];

  function setWalk(on){
    state.walkthrough = on;
    $("#walkBtn").textContent = `Walkthrough: ${on ? "ON" : "OFF"}`;
    toast("Walkthrough", on ? "Auto-cycling scenarios." : "Stopped.");
    if(on){
      state.walkStep = 0;
      walk[state.walkStep].run();
      state.walkTimer = setInterval(() => {
        state.walkStep = (state.walkStep + 1) % walk.length;
        walk[state.walkStep].run();
      }, 12000);
    } else {
      clearInterval(state.walkTimer);
      state.walkTimer = null;
    }
  }

  // ===== Export =====
  function exportAuditPack(){
    const payload = [
      `VERALOGIX — ${MODULE_NAME} (MOCK AUDIT PACK)`,
      `Site: ${state.site} · Range: ${state.range}`,
      `Generated: ${new Date().toString()}`,
      ``,
      `KPIs:`,
      `- Integrity Score: ${fmt.one(state.integrity)}`,
      `- Events/min: ${fmt.int(state.epm)}`,
      `- DQ: ${fmt.one(state.dq)}%`,
      `- Edge Buffer: ${fmt.int(state.edgeBuffer)} msgs`,
      `- Network p95: ${fmt.int(state.network.p95)} ms · Loss: ${fmt.one(state.network.loss)}%`,
      `- Mapping: ${state.mapping.version} (confidence ${state.mapping.confidence}%)`,
      ``,
      `Open Alerts:`,
      ...(state.alerts.filter(a=>a.open).slice(0,20).map(a => `- [${a.sev.toUpperCase()}] ${a.msg}`)),
      ``,
      `Recent Log (top 50):`,
      ...state.log.slice(0,50).map(r => `- ${r.ts} | ${r.who} | ${r.event} | ${r.status}`),
      ``,
      `Note: fabricated demo telemetry intended to resemble production patterns.`
    ].join("\n");

    const blob = new Blob([payload], {type:"text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `veralogix-audit-pack-${new Date().toISOString().slice(0,10)}.txt`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    toast("Exported", "Audit pack downloaded (demo).");
  }

  // ===== Main render =====
  function renderAll(){
    renderTop();
    renderKpis();
    renderConnectors();
    renderActions();
    renderLog();
    drawChart();
  }

  // ===== Bind events =====
  $("#siteSel").addEventListener("change", e => {
    state.site = e.target.value;
    addLog({ who:"EXCO", event:`Site changed to ${state.site}`, status:"OK", sev:"info" });
    renderAll();
  });
  $("#rangeSel").addEventListener("change", e => {
    state.range = e.target.value;
    addLog({ who:"EXCO", event:`Range changed to ${state.range}`, status:"OK", sev:"info" });
    renderAll();
  });

  $("#logFilter").addEventListener("change", renderLog);

  $("#walkBtn").addEventListener("click", () => setWalk(!state.walkthrough));
  $("#exportBtn").addEventListener("click", exportAuditPack);
  $("#clearAlerts").addEventListener("click", () => { resolveAll(); renderAll(); });

  $("#tOutage").addEventListener("click", triggerOutage);
  $("#tDust").addEventListener("click", triggerDust);
  $("#tCal").addEventListener("click", () => { openModal(); startCalibration(); });

  $("#openLab").addEventListener("click", openModal);
  $("#closeModal").addEventListener("click", closeModal);
  $("#modalBack").addEventListener("click", (e) => { if(e.target === $("#modalBack")) closeModal(); });

  $("#startCal").addEventListener("click", startCalibration);
  $("#publishMap").addEventListener("click", publishMapping);

  // ===== Tick loop =====
  function tick(){
    $("#clock").textContent = fmt.time();

    simulateNetwork();
    simulateConnectors();
    simulatePipeline();

    // pulse occasionally to show "data path" activity
    if(rand() < 0.22 && state.network.state !== "offline"){
      pulse(true);
      setTimeout(() => pulse(false), 1600);
    }

    // recovery auto
    if(state.network.state === "offline" && rand() < 0.04){
      state.network.state = "degraded";
      addAlert("warn", "Link restored but degraded. Monitoring p95 + loss (demo).");
    } else if(state.network.state === "degraded" && rand() < 0.06){
      state.network.state = "online";
      addAlert("info", "Link stabilized. Backlog flush expected (demo).");
      state.connectors.forEach(c => c.state = "online");
    }

    renderAll();
  }

  // Bootstrap
  addLog({ who:"System", event:"Showcase started (offline demo).", status:"OK", sev:"info" });
  toast("Demo ready", "Mock app running offline. Use Walkthrough for auto-demo.");
  renderAll();
  setInterval(tick, 1000);

})();
</script>
</body>
</html>
